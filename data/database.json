// js/database.js - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–• –ë–ï–ó –ë–ê–ì–û–í
class Database {
    constructor() {
        this.dbName = 'leo_assistant_db_v2'; // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        this.init();
    }

    init() {
        if (!localStorage.getItem(this.dbName)) {
            console.log('üìÅ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...');
            const initialData = {
                version: "2.0",
                users: [], // –ê–ë–°–û–õ–Æ–¢–ù–û –ü–£–°–¢–û–ô —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                classes: {
                    "7B": {
                        schedule: [
                            {"day": "–ü–Ω", "lessons": ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (212)", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫ (108)", "–§–∏–∑–∏–∫–∞ (305)"]},
                            {"day": "–í—Ç", "lessons": ["–ê–Ω–≥–ª–∏–π—Å–∫–∏–π (203)", "–ò—Å—Ç–æ—Ä–∏—è (111)", "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ (109)"]},
                            {"day": "–°—Ä", "lessons": ["–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞ (415)", "–ë–∏–æ–ª–æ–≥–∏—è (208)", "–ì–µ–æ–º–µ—Ç—Ä–∏—è (212)"]}
                        ],
                        tasks: [
                            {"id": 1, "subject": "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "title": "‚Ññ345-348 —Å—Ç—Ä. 45", "dueDate": "2024-05-20", "priority": "high"},
                            {"id": 2, "subject": "–§–∏–∑–∏–∫–∞", "title": "–õ–∞–±. —Ä–∞–±–æ—Ç–∞ ‚Ññ3", "dueDate": "2024-05-22", "priority": "medium"},
                            {"id": 3, "subject": "–ò—Å—Ç–æ—Ä–∏—è", "title": "–ö–æ–Ω—Å–ø–µ–∫—Ç ¬ß18", "dueDate": "2024-05-25", "priority": "low"}
                        ],
                        students: [] // –ü–£–°–¢–û–ô —Å–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤
                    }
                },
                ai_knowledge: {
                    greetings: ["–ü—Ä–∏–≤–µ—Ç! –Ø –õ–µ–æ, —Ç–≤–æ–π AI –ø–æ–º–æ—â–Ω–∏–∫.", "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å —É—á–µ–±–æ–π."],
                    subjects: {
                        math: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏–∑—É—á–∞–µ—Ç —á–∏—Å–ª–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.",
                        physics: "–§–∏–∑–∏–∫–∞ - –Ω–∞—É–∫–∞ –æ –ø—Ä–∏—Ä–æ–¥–µ."
                    }
                },
                system: {
                    admin_password: "admin123", // –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    total_logins: 0,
                    maintenance_mode: false,
                    registration_enabled: true
                }
            };
            
            // –°–û–ó–î–ê–ï–ú –¢–û–õ–¨–ö–û –û–î–ù–û–ì–û –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
            initialData.users.push({
                id: 1,
                login: "admin",
                password: "admin123", // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ —Ö—ç—à–∏—Ä–æ–≤–∞—Ç—å!
                name: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã",
                avatar: "–ê–°",
                class: "admin",
                role: "admin",
                points: 0,
                level: 99,
                created_at: new Date().toISOString(),
                tasks_completed: [],
                settings: {}
            });
            
            this.save(initialData);
            console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —Å –æ–¥–Ω–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º');
        }
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    save(data) {
        try {
            localStorage.setItem(this.dbName, JSON.stringify(data));
            return true;
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            return false;
        }
    }

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    getAll() {
        try {
            const data = localStorage.getItem(this.dbName);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            return null;
        }
    }

    // ===== –†–ê–ë–û–¢–ê –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò =====
    
    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addUser(userData) {
        const db = this.getAll();
        if (!db) {
            return { success: false, error: "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–Ω
        const login = userData.login.trim();
        if (!login) {
            return { success: false, error: "–õ–æ–≥–∏–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º" };
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –ª–æ–≥–∏–Ω–∞
        const userExists = db.users.some(u => 
            u.login.toLowerCase() === login.toLowerCase()
        );
        
        if (userExists) {
            return { success: false, error: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" };
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è
        const name = userData.name?.trim() || login;
        if (!name) {
            return { success: false, error: "–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º" };
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
        const password = userData.password;
        if (!password || password.length < 4) {
            return { success: false, error: "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤" };
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const newUser = {
            id: Date.now(),
            login: login,
            password: password,
            name: name,
            avatar: this.generateAvatar(name),
            class: "7B",
            role: "student",
            points: 0,
            level: 1,
            experience: 0,
            tasks_completed: [],
            achievements: [],
            last_login: null,
            created_at: new Date().toISOString(),
            settings: {
                theme: "dark",
                notifications: true,
                voice_assistant: true
            }
        };

        db.users.push(newUser);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–ª–∞—Å—Å
        if (!db.classes["7B"]) {
            db.classes["7B"] = { students: [], tasks: [], schedule: [] };
        }
        
        if (!db.classes["7B"].students) {
            db.classes["7B"].students = [];
        }
        
        db.classes["7B"].students.push({
            id: newUser.id,
            name: newUser.name,
            points: 0,
            level: 1,
            avatar: newUser.avatar
        });

        if (this.save(db)) {
            console.log(`‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: ${newUser.name} (${newUser.login})`);
            return { success: true, user: newUser };
        } else {
            return { success: false, error: "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö" };
        }
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    authUser(login, password) {
        const db = this.getAll();
        if (!db) {
            console.error('‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            return null;
        }

        const user = db.users.find(u => 
            u.login.toLowerCase() === login.toLowerCase() && 
            u.password === password
        );

        if (user) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ª–æ–≥–∏–Ω–æ–≤
            db.system.total_logins = (db.system.total_logins || 0) + 1;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
            user.last_login = new Date().toISOString();
            
            this.save(db);
            
            // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const { password: _, ...userWithoutPassword } = user;
            console.log(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥: ${user.name}`);
            return userWithoutPassword;
        }

        console.log(`‚ùå –ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: ${login}`);
        return null;
    }

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    authAdmin(password) {
        const db = this.getAll();
        if (!db) return false;

        return password === db.system.admin_password;
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –∫–ª–∞—Å—Å–∞
    getClassRating(className = "7B") {
        const db = this.getAll();
        if (!db || !db.classes || !db.classes[className] || !db.classes[className].students) {
            return [];
        }

        return db.classes[className].students
            .sort((a, b) => b.points - a.points)
            .slice(0, 10);
    }

    // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ =====
    
    generateAvatar(name) {
        const names = name.split(' ').filter(n => n.length > 0);
        if (names.length >= 2) {
            return (names[0][0] + names[1][0]).toUpperCase();
        }
        if (name.length >= 2) {
            return name.substring(0, 2).toUpperCase();
        }
        return "??";
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    getStats() {
        const db = this.getAll();
        if (!db) return null;

        const regularUsers = db.users.filter(u => u.role === 'student');
        
        return {
            total_users: db.users.length,
            regular_users: regularUsers.length,
            admin_users: db.users.filter(u => u.role === 'admin').length,
            total_logins: db.system.total_logins || 0,
            total_points: regularUsers.reduce((sum, user) => sum + user.points, 0)
        };
    }

    // –°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    resetDatabase() {
        localStorage.removeItem(this.dbName);
        this.init();
        console.log('üîÑ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–±—Ä–æ—à–µ–Ω–∞');
    }
}

// –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.leoDB = new Database();
