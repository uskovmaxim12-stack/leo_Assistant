// js/main.js - –ß–ò–°–¢–ê–Ø –õ–û–ì–ò–ö–ê –ë–ï–ó –î–ï–ú–û
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Leo Assistant –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º
    document.querySelectorAll('.form-switch').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.getAttribute('data-target');
            
            document.querySelectorAll('.form').forEach(form => {
                form.classList.remove('active');
            });
            
            document.getElementById(target + 'Form').classList.add('active');
        });
    });

    // ========== –í–•–û–î –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
    document.getElementById('loginBtn')?.addEventListener('click', function() {
        const login = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        
        if (!login || !password) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
        const user = leoDB.getUser(login, password);
        
        if (user) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ø–∞—Ä–æ–ª—è)
            const userData = {
                id: user.id,
                name: user.name,
                login: user.login,
                avatar: user.avatar,
                class: user.class,
                points: user.points || 0,
                level: user.level || 1
            };
            
            localStorage.setItem('current_user', JSON.stringify(userData));
            
            showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.name}!`, 'success');
            
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1000);
        } else {
            showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
        }
    });

    // ========== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ==========
    document.getElementById('registerBtn')?.addEventListener('click', function() {
        const login = document.getElementById('regLogin').value.trim();
        const name = document.getElementById('regName').value.trim();
        const password = document.getElementById('regPassword').value.trim();
        const confirmPassword = document.getElementById('regConfirmPassword').value.trim();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∏
        if (!login || !name || !password || !confirmPassword) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
            return;
        }
        
        if (password.length < 4) {
            showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
            return;
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const result = leoDB.addUser({
            login: login,
            name: name,
            password: password
        });
        
        if (result.success) {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º
            const userData = {
                id: result.user.id,
                name: result.user.name,
                login: result.user.login,
                avatar: result.user.avatar,
                class: result.user.class,
                points: result.user.points,
                level: result.user.level
            };
            
            localStorage.setItem('current_user', JSON.stringify(userData));
            
            showNotification(`–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è ${name}!`, 'success');
            
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1500);
        } else {
            showNotification(result.error, 'error');
        }
    });

    // ========== –í–•–û–î –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ==========
    document.getElementById('adminBtn')?.addEventListener('click', function() {
        const password = document.getElementById('adminPassword').value.trim();
        
        // –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (password === 'admin123') {
            localStorage.setItem('is_admin', 'true');
            showNotification('–í—Ö–æ–¥ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 'success');
            
            setTimeout(() => {
                window.location.href = 'admin.html';
            }, 1000);
        } else {
            showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error');
        }
    });

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function showNotification(message, type = 'info') {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const oldNotification = document.querySelector('.notification');
        if (oldNotification) oldNotification.remove();
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        // –°—Ç–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        `;
        
        document.body.appendChild(notification);
        
        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
});
